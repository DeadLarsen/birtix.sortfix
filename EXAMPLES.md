# –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è DeadLarsen IblockSortFix

–í —ç—Ç–æ–º –¥–æ–∫—É–º–µ–Ω—Ç–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω—ã –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –º–æ–¥—É–ª—è DeadLarsen IblockSortFix –¥–ª—è —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤.

## üìã –û–≥–ª–∞–≤–ª–µ–Ω–∏–µ

- [–ë–∞–∑–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏](#–±–∞–∑–æ–≤—ã–µ-–æ–ø–µ—Ä–∞—Ü–∏–∏)
- [–†–∞–±–æ—Ç–∞ —Å –±–µ–∫–∞–ø–∞–º–∏](#—Ä–∞–±–æ—Ç–∞-—Å-–±–µ–∫–∞–ø–∞–º–∏)
- [–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ CLI](#–∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è-—á–µ—Ä–µ–∑-cli)
- [–ü—Ä–æ–≥—Ä–∞–º–º–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ](#–ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ–µ-–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ)
- [–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞](#–º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥-–∏-–¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞)
- [–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏](#–ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã–µ-—Å—Ü–µ–Ω–∞—Ä–∏–∏)

## –ë–∞–∑–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏

### –ü–µ—Ä–≤–∏—á–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞

```bash
# –ü–æ–ª—É—á–∏—Ç—å –æ–±—â—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
php local/modules/deadlarsen.iblocksortfix/cli/sort_fix.php stats

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –µ—Å—Ç—å –ª–∏ –ø—Ä–æ–±–ª–µ–º—ã —Å —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–æ–π
php local/modules/deadlarsen.iblocksortfix/cli/sort_fix.php check
```

**–ü—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞:**
```
=== –°–¢–ê–¢–ò–°–¢–ò–ö–ê –≠–õ–ï–ú–ï–ù–¢–û–í –ò–ù–§–û–ë–õ–û–ö–û–í ===

–í—Å–µ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤ —Å–∏—Å—Ç–µ–º–µ: 1542

ID    –ù–∞–∑–≤–∞–Ω–∏–µ               –ö–æ–¥               –≠–ª–µ–º–µ–Ω—Ç–æ–≤ Min SORT   Max SORT  
-----------------------------------------------------------------------------------------------
1     –ù–æ–≤–æ—Å—Ç–∏               news                 245        100       24500     
2     –¢–æ–≤–∞—Ä—ã                catalog              890        500       500       
3     –°—Ç–∞—Ç—å–∏                articles             125        1         999       
```

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º–Ω–æ–≥–æ –∏–Ω—Ñ–æ–±–ª–æ–∫–∞

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –∏–Ω—Ñ–æ–±–ª–æ–∫
php local/modules/deadlarsen.iblocksortfix/cli/sort_fix.php check 3

# –ò—Å–ø—Ä–∞–≤–∏—Ç—å —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É
echo "y" | php local/modules/deadlarsen.iblocksortfix/cli/sort_fix.php fix 3
```

## –†–∞–±–æ—Ç–∞ —Å –±–µ–∫–∞–ø–∞–º–∏

### –°–æ–∑–¥–∞–Ω–∏–µ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–µ–∫–∞–ø–∞–º–∏

```bash
# –°–æ–∑–¥–∞—Ç—å –±–µ–∫–∞–ø –≤—Å–µ–π —Ç–∞–±–ª–∏—Ü—ã
php local/modules/deadlarsen.iblocksortfix/cli/sort_fix.php backup

# –°–æ–∑–¥–∞—Ç—å –±–µ–∫–∞–ø –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∏–Ω—Ñ–æ–±–ª–æ–∫–∞
php local/modules/deadlarsen.iblocksortfix/cli/sort_fix.php backup 384

# –°–æ–∑–¥–∞—Ç—å –∏–º–µ–Ω–æ–≤–∞–Ω–Ω—ã–π –±–µ–∫–∞–ø –¥–ª—è –≤–∞–∂–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π
php local/modules/deadlarsen.iblocksortfix/cli/sort_fix.php backup 384 before_migration

# –ü—Ä–æ—Å–º–æ—Ç—Ä –≤—Å–µ—Ö –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –±–µ–∫–∞–ø–æ–≤
php local/modules/deadlarsen.iblocksortfix/cli/sort_fix.php backup-list
```

**–ü—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞ —Å–ø–∏—Å–∫–∞ –±–µ–∫–∞–ø–æ–≤:**
```
=== –°–ü–ò–°–û–ö –ë–ï–ö–ê–ü–û–í ===

–ò–º—è –±–µ–∫–∞–ø–∞                              –ó–∞–ø–∏—Å–µ–π  –†–∞–∑–º–µ—Ä –ú–ë –°—Ç–∞—Ä–µ–π—à–∞—è –∑–∞–ø–∏—Å—å     –ù–æ–≤–µ–π—à–∞—è –∑–∞–ø–∏—Å—å
----------------------------------------------------------------------------------------------------------------------
b_iblock_element_backup_2025_01_29_14_30_15 1542    45.67     2024-01-15 10:30:25  2025-01-29 14:25:10
b_iblock_element_backup_before_migration     890     23.45     2024-01-15 10:30:25  2025-01-29 12:15:30
```

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å –±–µ–∫–∞–ø–æ–º

```bash
# –ò—Å–ø—Ä–∞–≤–∏—Ç—å –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º —Å–æ–∑–¥–∞–Ω–∏–µ–º –±–µ–∫–∞–ø–∞
echo "y" | php local/modules/deadlarsen.iblocksortfix/cli/sort_fix.php fix --backup

# –ò—Å–ø—Ä–∞–≤–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –∏–Ω—Ñ–æ–±–ª–æ–∫ —Å –±–µ–∫–∞–ø–æ–º
echo "y" | php local/modules/deadlarsen.iblocksortfix/cli/sort_fix.php fix 384 --backup
```

### –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö

```bash
# –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å—é —Ç–∞–±–ª–∏—Ü—É –∏–∑ –±–µ–∫–∞–ø–∞
echo "y" | php local/modules/deadlarsen.iblocksortfix/cli/sort_fix.php restore backup_name

# –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –∏–Ω—Ñ–æ–±–ª–æ–∫
echo "y" | php local/modules/deadlarsen.iblocksortfix/cli/sort_fix.php restore backup_name 384
```

### –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –±–µ–∫–∞–ø–æ–≤

```bash
# –£–¥–∞–ª–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –±–µ–∫–∞–ø
echo "y" | php local/modules/deadlarsen.iblocksortfix/cli/sort_fix.php backup-delete old_backup_name
```

### –°—Ü–µ–Ω–∞—Ä–∏–π –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

```bash
#!/bin/bash

# –°–æ–∑–¥–∞–µ–º –±–µ–∫–∞–ø –ø–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º
echo "–°–æ–∑–¥–∞–Ω–∏–µ –±–µ–∫–∞–ø–∞ –ø–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º..."
php local/modules/deadlarsen.iblocksortfix/cli/sort_fix.php backup "" "before_update_$(date +%Y%m%d_%H%M%S)"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
php local/modules/deadlarsen.iblocksortfix/cli/sort_fix.php check

# –í—ã–ø–æ–ª–Ω—è–µ–º –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º
echo "y" | php local/modules/deadlarsen.iblocksortfix/cli/sort_fix.php fix --backup

echo "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ!"
```

## –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ CLI

### –°–∫—Ä–∏–ø—Ç –¥–ª—è —Ä–µ–≥—É–ª—è—Ä–Ω–æ–≥–æ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è

–°–æ–∑–¥–∞–π—Ç–µ —Å–∫—Ä–∏–ø—Ç `maintenance.sh`:

```bash
#!/bin/bash

# –ü—É—Ç—å –∫ –∫–æ—Ä–Ω—é Bitrix
BITRIX_ROOT="/var/www/html"
CLI_SCRIPT="$BITRIX_ROOT/local/modules/deadlarsen.iblocksortfix/cli/sort_fix.php"
LOG_FILE="/var/log/sortfix-maintenance.log"

echo "=== SortFix Maintenance $(date) ===" >> $LOG_FILE

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è
php $CLI_SCRIPT check >> $LOG_FILE 2>&1

# –ï—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–æ–±–ª–µ–º—ã, –∏—Å–ø—Ä–∞–≤–ª—è–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ (–≤ –ø—Ä–æ–º—ã—à–ª–µ–Ω–Ω–æ–π —Å—Ä–µ–¥–µ –æ—Å—Ç–æ—Ä–æ–∂–Ω–æ!)
if php $CLI_SCRIPT check | grep -q "–¢–†–ï–ë–£–ï–¢–°–Ø –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï"; then
    echo "–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã —Å —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–æ–π, –∏—Å–ø—Ä–∞–≤–ª—è–µ–º..." >> $LOG_FILE
    echo "y" | php $CLI_SCRIPT fix >> $LOG_FILE 2>&1
    echo "–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ" >> $LOG_FILE
else
    echo "–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –≤ –ø–æ—Ä—è–¥–∫–µ" >> $LOG_FILE
fi

echo "=== Maintenance completed ===" >> $LOG_FILE
```

### Cron –∑–∞–¥–∞—á–∞

```bash
# –î–æ–±–∞–≤–∏—Ç—å –≤ crontab (crontab -e)
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 3:00
0 3 * * * /path/to/maintenance.sh

# –ò–ª–∏ —Ç–æ–ª—å–∫–æ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–∞–∂–¥—ã–µ 4 —á–∞—Å–∞
0 */4 * * * php /var/www/html/local/modules/deadlarsen.iblocksortfix/cli/sort_fix.php check
```

## –ü—Ä–æ–≥—Ä–∞–º–º–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –í –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ —Å–æ–±—ã—Ç–∏–π

```php
<?php
// –í —Ñ–∞–π–ª–µ /local/php_interface/init.php

use Bitrix\Main\Loader;
use DeadLarsen\IblockSortFix\Services\SortFixService;

// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –Ω–æ–≤—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
AddEventHandler("iblock", "OnAfterIBlockElementAdd", "checkAndFixSortOnAdd");

function checkAndFixSortOnAdd(&$arFields)
{
    if (!Loader::includeModule('bitrix.sortfix')) {
        return;
    }
    
    $iblockId = $arFields['IBLOCK_ID'];
    $sortFixService = new SortFixService();
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–ª—å–∫–æ –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–π –∏–Ω—Ñ–æ–±–ª–æ–∫
    $check = $sortFixService->checkSortNeedsFixing($iblockId);
    
    if ($check['needs_fixing']) {
        // –õ–æ–≥–∏—Ä—É–µ–º —Å–æ–±—ã—Ç–∏–µ
        AddMessage2Log(
            "–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –¥–ª—è –∏–Ω—Ñ–æ–±–ª–æ–∫–∞ {$iblockId}",
            "SORTFIX_AUTO"
        );
        
        // –°–æ–∑–¥–∞–µ–º –±–µ–∫–∞–ø –ø–µ—Ä–µ–¥ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º
        $backupResult = $sortFixService->createBackup($iblockId, "auto_fix_" . date('Y_m_d_H_i_s'));
        
        if ($backupResult['success']) {
            // –ò—Å–ø—Ä–∞–≤–ª—è–µ–º
            $result = $sortFixService->fixElementsSort($iblockId);
            
            if ($result['success']) {
                AddMessage2Log(
                    "–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ {$result['updated_count']} —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤ –∏–Ω—Ñ–æ–±–ª–æ–∫–µ {$iblockId}. –ë–µ–∫–∞–ø: {$backupResult['backup_name']}",
                    "SORTFIX_AUTO"
                );
            }
        }
    }
}
```

### –í –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–æ–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–µ

```php
<?php
// –í –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–µ –∞–¥–º–∏–Ω–∫–∏

use Bitrix\Main\Loader;
use DeadLarsen\IblockSortFix\Services\SortFixService;

if (Loader::includeModule('bitrix.sortfix')) {
    $sortFixService = new SortFixService();
    
    // –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
    $stats = $sortFixService->getElementsStats();
    $needsFixing = $sortFixService->checkSortNeedsFixing();
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –∞–¥–º–∏–Ω—É
    if ($needsFixing['needs_fixing']) {
        $message = "–í–Ω–∏–º–∞–Ω–∏–µ! –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã —Å —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–æ–π —ç–ª–µ–º–µ–Ω—Ç–æ–≤. ";
        $message .= "–ü—Ä–æ–±–ª–µ–º–Ω—ã—Ö –∏–Ω—Ñ–æ–±–ª–æ–∫–æ–≤: " . count($needsFixing['problem_iblocks']);
        
        CAdminMessage::ShowMessage([
            "MESSAGE" => $message,
            "TYPE" => "ERROR",
            "HTML" => true
        ]);
    }
}
```

### –í REST API

```php
<?php
// –°–æ–∑–¥–∞–Ω–∏–µ REST-endpoint –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è

use Bitrix\Main\Engine\Controller;
use Bitrix\Main\Loader;
use DeadLarsen\IblockSortFix\Services\SortFixService;

class SortFixController extends Controller
{
    public function getStatusAction()
    {
        if (!Loader::includeModule('bitrix.sortfix')) {
            return ['error' => 'Module not installed'];
        }
        
        $sortFixService = new SortFixService();
        
        return [
            'stats' => $sortFixService->getElementsStats(),
            'issues' => $sortFixService->checkSortNeedsFixing()
        ];
    }
    
    public function fixIblockAction($iblockId)
    {
        if (!Loader::includeModule('bitrix.sortfix')) {
            return ['error' => 'Module not installed'];
        }
        
        $sortFixService = new SortFixService();
        return $sortFixService->fixElementsSort($iblockId);
    }
}
```

### –ü—Ä–æ–≥—Ä–∞–º–º–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å –±–µ–∫–∞–ø–∞–º–∏

```php
<?php
// –ü—Ä–∏–º–µ—Ä –∫–ª–∞—Å—Å–∞ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±–µ–∫–∞–ø–∞–º–∏

use Bitrix\Main\Loader;
use DeadLarsen\IblockSortFix\Services\SortFixService;

class SortFixBackupManager
{
    private $sortFixService;
    
    public function __construct()
    {
        if (!Loader::includeModule('bitrix.sortfix')) {
            throw new Exception('Module bitrix.sortfix not installed');
        }
        
        $this->sortFixService = new SortFixService();
    }
    
    /**
     * –°–æ–∑–¥–∞—Ç—å –±–µ–∫–∞–ø –ø–µ—Ä–µ–¥ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–º–∏ –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏
     */
    public function createPreOperationBackup($operation, $iblockId = null)
    {
        $backupName = "before_{$operation}_" . date('Y_m_d_H_i_s');
        
        $result = $this->sortFixService->createBackup($iblockId, $backupName);
        
        if ($result['success']) {
            AddMessage2Log(
                "–°–æ–∑–¥–∞–Ω –±–µ–∫–∞–ø {$result['backup_name']} –ø–µ—Ä–µ–¥ –æ–ø–µ—Ä–∞—Ü–∏–µ–π {$operation}",
                "SORTFIX_BACKUP"
            );
        }
        
        return $result;
    }
    
    /**
     * –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –±–µ–∫–∞–ø–æ–º
     */
    public function safeFixSort($iblockId = null)
    {
        // –°–æ–∑–¥–∞–µ–º –±–µ–∫–∞–ø
        $backupResult = $this->createPreOperationBackup('sortfix', $iblockId);
        
        if (!$backupResult['success']) {
            return [
                'success' => false,
                'message' => '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –±–µ–∫–∞–ø: ' . $backupResult['message']
            ];
        }
        
        // –í—ã–ø–æ–ª–Ω—è–µ–º –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
        $fixResult = $this->sortFixService->fixElementsSort($iblockId);
        
        if (!$fixResult['success']) {
            // –ü—Ä–∏ –æ—à–∏–±–∫–µ –º–æ–∂–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
            $this->sortFixService->restoreFromBackup($backupResult['backup_name'], $iblockId);
        }
        
        return $fixResult;
    }
    
    /**
     * –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –±–µ–∫–∞–ø–æ–≤ (—Å—Ç–∞—Ä—à–µ 30 –¥–Ω–µ–π)
     */
    public function cleanupOldBackups($daysOld = 30)
    {
        $backupsResult = $this->sortFixService->listBackups();
        
        if (!$backupsResult['success']) {
            return;
        }
        
        $cutoffDate = date('Y-m-d H:i:s', strtotime("-{$daysOld} days"));
        
        foreach ($backupsResult['backups'] as $backup) {
            if ($backup['newest_record'] < $cutoffDate) {
                $deleteResult = $this->sortFixService->deleteBackup($backup['name']);
                
                if ($deleteResult['success']) {
                    AddMessage2Log(
                        "–£–¥–∞–ª–µ–Ω —Å—Ç–∞—Ä—ã–π –±–µ–∫–∞–ø: {$backup['name']}",
                        "SORTFIX_CLEANUP"
                    );
                }
            }
        }
    }
}

// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ –∫–æ–¥–µ
$backupManager = new SortFixBackupManager();

// –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
$result = $backupManager->safeFixSort(384);

// –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –±–µ–∫–∞–ø–æ–≤
$backupManager->cleanupOldBackups(7); // —É–¥–∞–ª–∏—Ç—å –±–µ–∫–∞–ø—ã —Å—Ç–∞—Ä—à–µ 7 –¥–Ω–µ–π
```

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

### –°–∫—Ä–∏–ø—Ç –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –¥–ª—è Nagios/Zabbix

```bash
#!/bin/bash
# check_sortfix.sh - —Å–∫—Ä–∏–ø—Ç –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

BITRIX_ROOT="/var/www/html"
CLI_SCRIPT="$BITRIX_ROOT/local/modules/deadlarsen.iblocksortfix/cli/sort_fix.php"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
OUTPUT=$(php $CLI_SCRIPT check 2>&1)

if echo "$OUTPUT" | grep -q "–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –≤ –ø–æ—Ä—è–¥–∫–µ"; then
    echo "OK - –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤ –Ω–æ—Ä–º–µ"
    exit 0
elif echo "$OUTPUT" | grep -q "–¢–†–ï–ë–£–ï–¢–°–Ø –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï"; then
    # –ò–∑–≤–ª–µ–∫–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö –∏–Ω—Ñ–æ–±–ª–æ–∫–æ–≤
    PROBLEM_COUNT=$(echo "$OUTPUT" | grep -c "–î–∞")
    echo "WARNING - –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã —Å —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–æ–π –≤ $PROBLEM_COUNT –∏–Ω—Ñ–æ–±–ª–æ–∫–∞—Ö"
    exit 1
else
    echo "CRITICAL - –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏"
    exit 2
fi
```

### –°–æ–∑–¥–∞–Ω–∏–µ –æ—Ç—á–µ—Ç–æ–≤

```php
<?php
// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞

use Bitrix\Main\Loader;
use DeadLarsen\IblockSortFix\Services\SortFixService;

if (Loader::includeModule('bitrix.sortfix')) {
    $sortFixService = new SortFixService();
    $stats = $sortFixService->getElementsStats();
    $issues = $sortFixService->checkSortNeedsFixing();
    
    $report = "=== –ï–ñ–ï–ù–ï–î–ï–õ–¨–ù–´–ô –û–¢–ß–ï–¢ SORTFIX ===\n\n";
    $report .= "–î–∞—Ç–∞: " . date('Y-m-d H:i:s') . "\n";
    $report .= "–í—Å–µ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤: " . $stats['total_elements'] . "\n";
    $report .= "–í—Å–µ–≥–æ –∏–Ω—Ñ–æ–±–ª–æ–∫–æ–≤: " . count($stats['iblock_stats']) . "\n\n";
    
    if ($issues['needs_fixing']) {
        $report .= "‚ö†Ô∏è –¢–†–ï–ë–£–ï–¢–°–Ø –í–ù–ò–ú–ê–ù–ò–ï:\n";
        $report .= "–ü—Ä–æ–±–ª–µ–º–Ω—ã—Ö –∏–Ω—Ñ–æ–±–ª–æ–∫–æ–≤: " . count($issues['problem_iblocks']) . "\n\n";
        
        foreach ($issues['problem_iblocks'] as $iblock) {
            $report .= sprintf(
                "- %s (ID: %d): %s\n",
                $iblock['name'],
                $iblock['id'],
                $iblock['has_duplicates'] ? '–¥—É–±–ª–∏–∫–∞—Ç—ã' : '–Ω–µ–∫—Ä–∞—Ç–Ω—ã–µ 100'
            );
        }
    } else {
        $report .= "‚úÖ –í—Å–µ –≤ –ø–æ—Ä—è–¥–∫–µ - –ø—Ä–æ–±–ª–µ–º –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ\n";
    }
    
    // –û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç—á–µ—Ç–∞ –ø–æ email
    mail(
        'admin@site.com',
        'SortFix Weekly Report',
        $report,
        'From: sortfix@site.com'
    );
}
```

## –ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏

### –ú–∞—Å—Å–æ–≤–∞—è –º–∏–≥—Ä–∞—Ü–∏—è

```bash
#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –º–∞—Å—Å–æ–≤–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏ –±–æ–ª—å—à–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞

BITRIX_ROOT="/var/www/html"
CLI_SCRIPT="$BITRIX_ROOT/local/modules/deadlarsen.iblocksortfix/cli/sort_fix.php"
BACKUP_DIR="/backup/sortfix"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)

echo "=== –ù–∞—á–∞–ª–æ –º–∞—Å—Å–æ–≤–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏ ==="

# 1. –°–æ–∑–¥–∞–µ–º –±—ç–∫–∞–ø –±–∞–∑—ã
echo "–°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏..."
mysqldump -u root -p database_name b_iblock_element > "$BACKUP_DIR/b_iblock_element_$TIMESTAMP.sql"

# 2. –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö –∏–Ω—Ñ–æ–±–ª–æ–∫–æ–≤
echo "–ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö –∏–Ω—Ñ–æ–±–ª–æ–∫–æ–≤..."
php $CLI_SCRIPT check > "$BACKUP_DIR/check_result_$TIMESTAMP.txt"

# 3. –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –ø–æ –æ–¥–Ω–æ–º—É –∏–Ω—Ñ–æ–±–ª–æ–∫—É —Å –ø–∞—É–∑–∞–º–∏
IBLOCK_IDS=(1 2 3 5 8 13 21)  # –°–ø–∏—Å–æ–∫ –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö –∏–Ω—Ñ–æ–±–ª–æ–∫–æ–≤

for iblock_id in "${IBLOCK_IDS[@]}"; do
    echo "–û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–Ω—Ñ–æ–±–ª–æ–∫–∞ $iblock_id..."
    
    # –ò—Å–ø—Ä–∞–≤–ª—è–µ–º
    echo "y" | php $CLI_SCRIPT fix $iblock_id
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    if php $CLI_SCRIPT check $iblock_id | grep -q "–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –≤ –ø–æ—Ä—è–¥–∫–µ"; then
        echo "‚úÖ –ò–Ω—Ñ–æ–±–ª–æ–∫ $iblock_id –æ–±—Ä–∞–±–æ—Ç–∞–Ω —É—Å–ø–µ—à–Ω–æ"
    else
        echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∏–Ω—Ñ–æ–±–ª–æ–∫–∞ $iblock_id"
        exit 1
    fi
    
    # –ü–∞—É–∑–∞ –º–µ–∂–¥—É –æ–±—Ä–∞–±–æ—Ç–∫–æ–π (—Å–Ω–∏–∂–∞–µ–º –Ω–∞–≥—Ä—É–∑–∫—É)
    sleep 5
done

echo "=== –ú–∏–≥—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ ==="
```

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å CI/CD

```yaml
# .github/workflows/deploy.yml
name: Deploy with SortFix

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Deploy to server
      run: |
        # ... –∫–æ–¥ –¥–µ–ø–ª–æ—è ...
        
    - name: Run SortFix check
      run: |
        ssh user@server "cd /var/www/html && php local/modules/deadlarsen.iblocksortfix/cli/sort_fix.php check"
        
    - name: Auto-fix if needed
      run: |
        ssh user@server "cd /var/www/html && echo 'y' | php local/modules/deadlarsen.iblocksortfix/cli/sort_fix.php fix"
```

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

```php
<?php
// –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π

use Bitrix\Main\Loader;
use DeadLarsen\IblockSortFix\Services\SortFixService;

if (Loader::includeModule('bitrix.sortfix')) {
    $sortFixService = new SortFixService();
    
    // –ó–∞–º–µ—Ä—è–µ–º –≤—Ä–µ–º—è –ø—Ä–æ–≤–µ—Ä–∫–∏
    $startTime = microtime(true);
    $issues = $sortFixService->checkSortNeedsFixing();
    $checkTime = microtime(true) - $startTime;
    
    // –õ–æ–≥–∏—Ä—É–µ–º –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
    AddMessage2Log(
        sprintf("SortFix check completed in %.3f seconds", $checkTime),
        "SORTFIX_PERFORMANCE"
    );
    
    // –ï—Å–ª–∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–Ω–∏–º–∞–µ—Ç —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
    if ($checkTime > 10.0) {
        AddMessage2Log(
            "SortFix check is slow, consider optimizing database",
            "SORTFIX_WARNING"
        );
    }
}
```

–≠—Ç–∏ –ø—Ä–∏–º–µ—Ä—ã –ø–æ–∫—Ä—ã–≤–∞—é—Ç –æ—Å–Ω–æ–≤–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –º–æ–¥—É–ª—è –≤ —Ä–µ–∞–ª—å–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–∞—Ö. 